name: Rebuild Documentation Index

permissions:
  contents: write
  statuses: write

# Trigger when documentation content changes
on:
  push:
    branches: [main]
    paths:
      - 'content/en/**/*.md'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual rebuild'
        required: false
        default: 'Manual trigger'

jobs:
  rebuild-index:
    runs-on: ubuntu-latest
    name: Rebuild Chatbot Documentation Index
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Wait for Netlify deployment
        if: github.event_name == 'push'
        run: |
          echo "⏳ Waiting 2 minutes for Netlify deployment to complete..."
          sleep 120
          
      - name: Get Netlify site URL
        id: get-url
        run: |
          # Try to get from Netlify API or use default
          SITE_URL="${{ secrets.NETLIFY_SITE_URL }}"
          if [ -z "$SITE_URL" ]; then
            SITE_URL="https://krkn-chaos.netlify.app"
          fi
          echo "SITE_URL=$SITE_URL" >> $GITHUB_OUTPUT
          echo "🌐 Using site URL: $SITE_URL"
          
      - name: Rebuild documentation index
        run: |
          echo "🔄 Triggering documentation index rebuild..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ steps.get-url.outputs.SITE_URL }}/api/admin/rebuild-index" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --max-time 30)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Documentation index rebuilt successfully!"
            # Parse document count if available
            if echo "$BODY" | grep -q "documentCount"; then
              DOC_COUNT=$(echo "$BODY" | grep -o '"documentCount":[0-9]*' | cut -d':' -f2)
              echo "📊 Indexed $DOC_COUNT documents"
            fi
          else
            echo "❌ Failed to rebuild index (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            exit 1
          fi
          
      - name: Create commit status
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: '${{ steps.get-url.outputs.SITE_URL }}',
              description: 'Documentation index rebuilt',
              context: 'chatbot/index-rebuild'
            });
            
      - name: Summary
        run: |
          echo "## 🚀 Documentation Index Rebuild Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL**: ${{ steps.get-url.outputs.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **Reason**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The chatbot documentation index has been automatically updated with the latest content!" >> $GITHUB_STEP_SUMMARY
